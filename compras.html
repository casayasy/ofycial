<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Compras</title>
  <link rel="icon" href="img/yasy.jpeg">

  <!-- BOOTSTRAP ICONS -->
  <link rel="stylesheet" href="bt-icons/bootstrap-icons.min.css">

  <!-- DATATABLES -->
  <link rel="stylesheet" href="dt/datatables.min.css">
  <link rel="stylesheet" href="dt/jquery.dataTables.min.css">
  <link rel="stylesheet" href="dt/buttons.dataTables.min.css">

  <!-- ALERTIFYJS -->
  <link rel="stylesheet" href="alert/alertify.min.css">
  <link rel="stylesheet" href="alert/themes/default.min.css">
  <script src="alert/alertify.min.js"></script>

  <!-- ESTILOS DEL MENU -->
  <link href="menu/styles.css" rel="stylesheet"/>
</head>

<body class="sb-nav-fixed">

    <nav class="sb-topnav navbar navbar-expand navbar-dark bg-dark">
        <!-- Navbar Brand-->
        <a class="navbar-brand ps-3" href="compras.html">Compras</a>

        <!-- Sidebar Toggle-->
        <button class="btn btn-link btn-sm order-1 order-lg-0 me-4 me-lg-0" id="sidebarToggle" href="#!"><i class="bi bi-list"></i></button>
        
        <!-- Navbar Search-->
        <!-- <form class="d-none d-md-inline-block form-inline ms-auto me-0 me-md-3 my-2 my-md-0">
            <div class="input-group">
                <input class="form-control" type="text" placeholder="Search for..." aria-label="Search for..." aria-describedby="btnNavbarSearch" />
                <button class="btn btn-primary" id="btnNavbarSearch" type="button"><i class="bi bi-search"></i></button>
            </div>
        </form> -->

        <!-- Navbar del Usuario-->
        <ul class="navbar-nav ms-auto ms-md-0 me-3 me-lg-4">
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" id="navbarDropdown" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-person-fill"></i></a>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                <li><a class="dropdown-item" href="#!">Config.</a></li>
                <li><hr class="dropdown-divider" /></li>
                <li><a class="dropdown-item" href="#" onclick="cerrarSesion()">Cerrar sesión</a></li>
                </ul>
            </li>
        </ul>
    </nav>

    <div id="layoutSidenav">

        <!-- Barra Lateral Izquierda, Menú Vertical -->
        <div id="layoutSidenav_nav">
            <nav class="sb-sidenav accordion sb-sidenav-dark" id="sidenavAccordion">
                <div class="sb-sidenav-menu">
                    <div class="nav">
                    <div class="sb-sidenav-menu-heading">Menu</div>
                    <a class="nav-link" href="menu.html">
                        <div class="sb-nav-link-icon"><i class="bi bi-house-door"></i></div>
                        Menu
                    </a>
                   
                    <a class="nav-link" href="#" id="linkVerTablas">
                        <div class="sb-nav-link-icon"><i class="bi bi-table"></i></div>
                        Compras detalle
                    </a>
                    <a class="nav-link" href="#" id="linkInformeCompras">
                        <div class="sb-nav-link-icon"><i class="bi bi-bar-chart-line"></i></div>
                        Informes
                    </a>
                    <div class="sb-sidenav-menu-heading"></div>


                   </div>
                    <div class="sb-sidenav-menu-heading"></div>
  
                    </div> 
                <!-- </div> -->
              
                <div class="sb-sidenav-footer">
                    <div class="small">Iniciado por:</div>
                    <div id="usuario"></div>
                </div>
            </nav>
            
        </div>

        <!-- CONTAINER DEL CONTENIDO -->
        <div id="layoutSidenav_content">

            <!-- CONTENIDO PRINCIPAL -->
            <main>
                <div class="container-fluid px-4">
                    <h1 class="mt-2">Compras</h1>

                    <!-- AQUÍ VA TODO LO QUE SE VA A VISUALIZAR EN LA PÁGINA -->
                    <form action="#" id="formCompras" class="modal-content">

                        <!-- CABECERA -->
                        <div class="row mx-1">

                            <div class="card">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-12 col-lg-6">
                                            <label class="form-label fw-bold">N° FACTURA</label>
                                            <input type="text" id="numfactura" class="form-control" maxlength="15"
                                            pattern="^\d{3}-\d{3}-\d{7}$"
                                            title="Formato: 000-000-0000000">
                                            <!-- <input type="text" id="numfactura" class="form-control" maxlength="15"> -->
                                        </div>
                                        
                                        <div class="col-12 col-lg-3">
                                            <label class="form-label fw-bold">FECHA</label>
                                            <input type="date" id="fecha" class="form-control" required>
                                        </div>
        
                                        <div class="col-12 col-lg-3">
                                            <label class="form-label fw-bold">CONDICIÓN</label>
                                            <select id="condicion" class="form-select">
                                                <option value="CONTADO">CONTADO</option>
                                                <option value="CRÉDITO">CRÉDITO</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="row mt-1">
                                        <div class="col-12 col-lg-3">
                                            <label class="form-label fw-bold">R.U.C.</label>
                                            <div class="input-group mb-3">
                                                <input type="text" 
                                                    inputmode="numeric"
                                                    pattern="^\d+(?:-\d)?$"
                                                    class="form-control" 
                                                    id="ruc" 
                                                    maxlength="13"
                                                    required>
                                                <button class="btn btn-outline-secondary" type="button" id="btnBuscarRUCCI"><i class="bi bi-search"></i></button>
                                            </div>
                                            <input type="hidden" id="idproveedor">
                                        </div>

                                        <div class="col">
                                            <label class="form-label fw-bold">PROVEEDOR</label>
                                            <input type="text" id="proveedor" class="form-control text-uppercase" readonly>
                                        </div>

                                    </div>
                                </div>
                            </div>

                        </div>

                        <!-- CARGA DE PRODUCTO -->
                        <div class="row mx-1 mt-2">

                            <div class="card">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-12 col-lg-3">
                                            <label class="form-label fw-bold">COD. BARRA</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="codbarra" required max="9999999999999" min="1">
                                                <button class="btn btn-outline-secondary" type="button" id="btnBuscarArticulo" ><i class="bi bi-search"></i></button>
                                            </div>
                                            <input type="hidden" id="idarticulo">
                                        </div>

                                        <div class="col">
                                            <label class="form-label fw-bold">DESCRIPCIÓN</label>
                                            <input type="text" id="descripcion" class="form-control text-uppercase" readonly>
                                        </div>
                                    </div>

                                    <div class="row mt-1">
                                        <div class="col-12 col-lg-3">
                                            <label class="form-label fw-bold">CANTIDAD</label>
                                            <input type="number" id="cantidad" class="form-control" required min="1" max="9999" value="1">
                                        </div>

                                        <div class="col">
                                            <label class="form-label fw-bold text-end ">PRECIO UNITARIO</label>
                                            <input type="number" id="preuni" class="form-control text-end" min="1">
                                        </div>

                                        <div class="col-sm-2">
                                            <label class="form-label fw-bold">SUBTOTAL</label>
                                            <input type="text" id="subtotal" class="form-control text-end" readonly>
                                        </div>

                                        <div class="col-12 col-lg-3">
                                            <label class="form-label fw-bold">TIPO DE IVA</label>
                                            <select id="tipoIva" class="form-select" disabled>
                                                <option value="0">EXENTA</option>
                                                <option value="5">IVA 5%</option>
                                                <option value="10">IVA 10%</option>
                                            </select>
                                        </div>

                                        <div class="col-12 col-lg-1 d-grid align-items-end">
                                            <button type="button" id="btnAgregarArticulo" class="btn btn-success" title="Agregar artículo"><i class="bi bi-plus-circle"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                        </div>

                        <!-- DETALLE DE COMPRA -->
                        <div class="row mx-1 mt-2">

                            <div class="card">
                                <div class="card-body">
                                    <div class="row">
                                        <table id="tablaArticulos" class="display" style="width:100%">
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- PIE DE COMPRA -->
                        <div class="row mx-1 mt-2">

                            <div class="card">
                                <div class="card-body">

                                    <!-- Total de subtotales -->
                                    <div class="row">
                                        <div class="col-2">
                                            <label class="form-label fw-bold ">Total Exenta</label>
                                            <input type="text" id="totExenta" class="form-control text-uppercase text-end" readonly>
                                        </div>

                                        <div class="col-2">
                                            <label class="form-label fw-bold">Total 5%</label>
                                            <input type="text" id="tot5" class="form-control text-uppercase text-end " readonly>
                                        </div>
                                        
                                        <div class="col-2">
                                            <label class="form-label fw-bold">Total 10%</label>
                                            <input type="text" id="tot10" class="form-control text-uppercase text-end " readonly>
                                        </div>

                                        <div class="col-2">
                                            <label class="form-label fw-bold">Total a Pagar</label>
                                            <input type="text" id="totalApagar" class="form-control text-uppercase text-end" readonly>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-2">
                                            <label class="form-label fw-bold">Liq. 5%</label>
                                            <input type="text" id="liq5" class="form-control text-uppercase text-end " readonly>
                                        </div>
                                        
                                        <div class="col-2">
                                            <label class="form-label fw-bold">Liq. 10%</label>
                                            <input type="text" id="liq10" class="form-control text-uppercase text-end" readonly>
                                        </div>

                                        <div class="col-4">
                                            <label class="form-label fw-bold">Total IVA</label>
                                            <input type="text" id="total" class="form-control text-uppercase text-end" readonly>
                                        </div>

                                        <div class="col-2 d-grid align-items-end">
                                            <button type="reset" class="btn btn-danger">Cancelar</button>
                                        </div>
                                        
                                        <div class="col-2 d-grid align-items-end">
                                            <button type="button" class="btn btn-primary" onclick="guardarCompra()">Guardar</button>
                                        </div>

                                        
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                    </form>
                    <br>
                    <!-- <div class="col-2 d-grid align-items-end">
                        <button type="button" id="btnVerTablas" class="btn btn-outline-primary btn-lg shadow-sm" title="Ver tablas de compras y detalles">
                            <i class="bi bi-table fs-3"></i>
                        </button>
                    </div> -->
                </div>

                <!-- Modal de búsqueda de proveedor -->
                <div class="modal fade modal-fullscreen" id="modalProveedores" tabindex="-1" aria-labelledby="modalProveedoresLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="modalProveedoresLabel">Buscar Proveedor</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                            </div>
                            <div class="modal-body">
                                <table id="tabla_proveedores" class="display compact" style="width:100%">
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal de búsqueda de producto -->
                <div class="modal fade" id="modalArticulos" tabindex="-1" aria-labelledby="modalArticulosLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="modalArticulosLabel">Buscar Artículo</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                            </div>
                            <div class="modal-body">
                                <table id="tabla_articulos" class="display compact" style="width:100%">
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal para visualizar compras y detalles -->
                    <div class="modal fade" id="modalVerTablas" tabindex="-1" aria-labelledby="modalVerTablasLabel" aria-hidden="true">
                    <div class="modal-dialog modal-xl modal-dialog-scrollable">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="modalVerTablasLabel">Compras y Detalles</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                            </div>
                            <div class="modal-body">
                                <h5>Tabla de Compras</h5>
                                <table id="tablaCompras" class="table table-bordered table-sm">
                                <thead>
                                    <tr>
                                    <th>ID Compra</th>
                                    <th>Proveedor</th>
                                    <th>RUC</th>
                                    <th>Fecha</th>
                                    <th>Condición</th>
                                    <th>N° Factura</th>
                                    <th>Total IVA</th>
                                    <th>Total a Pagar</th>
                                    <th>Pagado</th>
                                    <th>Ver Detalle</th>
                                    </tr>
                                </thead>
                                <tbody id="cabecera_compras">

                                </tbody>
                                </table>
                                <h5 class="mt-4">Detalle de la Compra Seleccionada</h5>
                                <table id="tablaDetalleCompra" class="table table-bordered table-sm">
                                <thead>
                                    <tr>
                                    <th>ID Artículo</th>
                                    <th>Código Barra</th>
                                    <th>Descripción</th>
                                    <th>Cantidad</th>
                                    <th>Precio Unitario</th>
                                    <th>Subtotal</th>
                                    <th>Exenta</th>
                                    <th>IVA 5%</th>
                                    <th>IVA 10%</th>
                                    </tr>
                                </thead>
                                <tbody id="detalle_compras">

                                </tbody>
                                </table>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cerrar</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal Informe de Compras -->
                <div class="modal fade" id="modalInformeCompras" tabindex="-1" aria-labelledby="modalInformeComprasLabel" aria-hidden="true">
                    <div class="modal-dialog modal-xl modal-dialog-scrollable">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="modalInformeComprasLabel">Informe de Compras</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                            </div>
                            <div class="modal-body">

                                <form id="formFiltrosInformeCompras" class="row g-3 mb-3">
                                    <div class="col-md-3">
                                        <label for="filtroDesdeCompras" class="form-label">Fecha Desde</label>
                                        <input type="date" class="form-control" id="filtroDesdeCompras">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="filtroHastaCompras" class="form-label">Fecha Hasta</label>
                                        <input type="date" class="form-control" id="filtroHastaCompras">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="filtroCondicionCompras" class="form-label">Condición</label>
                                        <select id="filtroCondicionCompras" class="form-select">
                                            <option value="">Todas</option>
                                            <option value="CONTADO">Contado</option>
                                            <option value="CRÉDITO">Crédito</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="filtroEstadoCompras" class="form-label">Pagado</label>
                                        <select id="filtroEstadoCompras" class="form-select">
                                            <option value="">Todas</option>
                                            <option value="no">Si</option>
                                            <option value="si">No</option>
                                          
                                        </select>
                                    </div>
                                    <div class="col-12">
                                        <button type="button" class="btn btn-primary" onclick="aplicarFiltrosInformeCompras()">Aplicar filtros</button>
                                        <button type="button" class="btn btn-warning" onclick="resetearFiltrosInformeCompras()">Restablecer filtros</button>
                                    </div>
                                </form>

                                <div class="table-responsive">
                                    <table class="table table-bordered table-striped" id="tablaInformeCompras">
                                        <thead>
                                            <tr>
                                                <th>Factura</th>
                                                <th>Fecha</th>
                                                <th>Proveedor</th>
                                                <th class="text-end">Total</th>
                                                <th class="text-end">IVA</th>
                                                <th>Condición</th>
                                                <!-- <th>Estado</th> -->
                                                <th>Pagado</th>
                                            </tr>
                                        </thead>
                                        <tbody id="cuerpoInformeCompras">
                                            <!-- Aquí van las filas que mostraremos -->
                                        </tbody>
                                    </table>
                                </div>

                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            </div>
                            <div class="d-flex justify-content-end gap-2 mt-3">
                                <button class="btn btn-success" onclick="exportarExcelCompras()">Exportar a Excel</button>
                                <button class="btn btn-danger" onclick="exportarPDFCompras()">Exportar a PDF</button>
                            </div>
                        </div>
                    </div>
                </div>

            </main>

            <!-- PIE DE PAGINA -->
            <footer class="py-4 bg-light mt-auto">
                <div class="container-fluid px-4">
                <div class="d-flex align-items-center justify-content-between small">
                    <div class="text-muted">Copyright &copy; Your Website 2025</div>
                    <div>
                    <a href="#">Política de Privacidad</a>
                    &middot;
                    <a href="#">Terminos &amp; Condiciones</a>
                    </div>
                </div>
                </div>
            </footer>
        </div>

    </div>

    
  

    <!-- Importar el archivo JavaScript -->
    <script src="js/menu.js"></script>
    <script src="js/bdP.js"></script>
    <script src="js/sistemFunctions.js"></script>
    <script src="menu/bootstrap.bundle.min.js"></script>
    <script src="menu/scripts.js"></script>

    <!-- DATATABLES -->
    <script src="dt/jquery-3.7.1.js"></script>
    <script src="dt/datatables.min.js"></script>
    <script src="dt/jquery.dataTables.min.js"></script>

    <!-- DATATABLES Buttons extension -->
    <script src="dt/dataTables.buttons.min.js"></script>
    <script src="dt/buttons.print.min.js"></script>
    <script src="dt/buttons.html5.min.js"></script>

    <!-- DATATABLES JSZip y pdfmake para exportar -->
    <script src="dt/jszip.min.js"></script>
    <script src="dt/pdfmake.min.js"></script>
    <script src="dt/vfs_fonts.js"></script>
    
    <!-- DATATABLES Idioma Español -->
    <script src="dt/es-ES.js"></script>

    <script>
        // Verificar si existe sesión activa
        if (!sessionStorage.getItem("sesionActiva")) {
            localStorage.removeItem("nomUsuario");
            localStorage.removeItem("rolUsuario");
            window.location.href = "Pagerror.html";
        }

        // para desplegar el menu lateral
        document.getElementById('sidebarToggle').addEventListener('click', function (e) {
            e.preventDefault();
            document.body.classList.toggle('sb-sidenav-toggled');
        });

        // Variables globales
        document.getElementById('usuario').textContent = localStorage.getItem("nomUsuario") || "Usuario";
        let proveedores = JSON.parse(localStorage.getItem("proveedores")) || [];
        let articulos = JSON.parse(localStorage.getItem("articulos")) || [];
        let marcas = JSON.parse(localStorage.getItem("marcas")) || [];
        let clasificaciones = JSON.parse(localStorage.getItem("clasificaciones")) || [];
        // Crear diccionarios para acceso rápido por ID
        let dicMarcas = {};
        marcas.forEach(m => dicMarcas[m.idmarca] = m.marca);
        let dicClasificaciones = {};
        clasificaciones.forEach(c => dicClasificaciones[c.idclasificacion] = c.clasificacion);
        let articulosConNombres = [];
        let compras = JSON.parse(localStorage.getItem("compras")) || [];
        let detalleCompra = [];
        let tablaDetalle;
        let tabla;

        // Totales
        let totalExenta = 0;
        let total5 = 0;
        let total10 = 0;
        let liq5 = 0;
        let liq10 = 0;
        let totalGeneral = 0;
        let totalAPagar = 0;
        let SUBTOTAL=0;

        /**
         * Inicialización cuando el DOM está completamente cargado
         */
        document.addEventListener('DOMContentLoaded', function () {
            // Establecer fecha actual
            const fechaActual = new Date().toISOString().split('T')[0];
            // Establecer el valor máximo para la fecha, no permite fecha futura
            document.getElementById("fecha").max = fechaActual;
            // Establecer la fecha actual como valor por defecto
            document.getElementById('fecha').value = fechaActual;
            
            // Inicializar DataTable
            inicializarTablaArticulos();
            
            // Configurar eventos
            configurarEventos();

            document.getElementById("numfactura").focus();
        });


        /**
         * Inicializa la tabla de artículos
         */
        function inicializarTablaArticulos() {
            articulosConNombres = articulos.map(a => {
                return {
                    ...a,
                    marca: dicMarcas[a.idmarca] || "Desconocido",
                    clasificacion: dicClasificaciones[a.idclasificacion] || "Desconocido"
                };
            });

            if ($.fn.DataTable.isDataTable('#tabla_articulos')) {3
                $('#tabla_articulos').DataTable().destroy();
            }

            tablaDetalle = new DataTable("#tablaArticulos", {
                data: detalleCompra,
                scrollY: '200px',
                scrollCollapse: true,
                info: false,
                ordering: false,
                language: spanish,
                searching: false,
                paging: false,
                columns: [
                    { data: 'idarticulo', title: 'Id Articulo', targets: 0, visible: false },
                    { data: 'cantidad', title: 'Cant.', targets: 0, width: '5%' },
                    { data: 'codbarra', title: 'Cod. Barra', targets: 0, width: '12%' },
                    { data: 'descripcion', title: 'Descripción', targets: 0, width: '35%' },
                    { data: 'preuni', title: 'Pre. Uni.', targets: 0, width: '12%', className: 'text-end' },
                    { data: 'subtotal', title: 'Subtotal', targets: 0, width: '12%', className: 'text-end' },
                    { data: 'exenta', title: 'Exenta', targets: 0, width: '12%', className: 'text-end' },
                    { data: 'iva5', title: 'IVA 5%', targets: 0, width: '12%', className: 'text-end' },
                    { data: 'iva10', title: 'IVA 10%', targets: 0, width: '12%', className: 'text-end' },
                    {
                        data: null,
                        title: 'Acción',
                        render: function (data, type, row) {
                            return `<button class="btn btn-sm btn-danger btn-eliminar-articulo" data-id="${row.idarticulo}"><i class="bi bi-trash"></i></button>`;
                        }
                    }
                ]
            });
        }


        function calcularSubtotal() {
                const cantidad = parseFloat(document.getElementById("cantidad").value.replace(/\./g, "")) || 0;
                const preuni = parseFloat(document.getElementById("preuni").value.replace(/\./g, "")) || 0;
                const subtotal = cantidad * preuni;

                // Formatear con separador de miles
                const subtotalFormateado = subtotal.toLocaleString("es-PY");
                document.getElementById("subtotal").value = subtotalFormateado;
            }

        /**
         * Configura todos los eventos necesarios
         */
        function configurarEventos() {
            // Evento para buscar proveedor por RUC
            document.getElementById("cantidad").addEventListener("input", calcularSubtotal);
            document.getElementById("preuni").addEventListener("input", calcularSubtotal);
            document.getElementById("codbarra").addEventListener("input", function() {
                
                calcularSubtotal();
            });
            document.getElementById('btnBuscarRUCCI').addEventListener('click', buscarProveedorPorRUC);
            document.getElementById('ruc').addEventListener('blur', function() {
                const rucIngresado = this.value?.trim();

                if (rucIngresado === undefined || rucIngresado === "") 
                    return; // no hace nada si está vacío
            
                var proveedores = JSON.parse(localStorage.getItem("proveedores")) || [];
                
                var proveedor = proveedores.find(p => p.ruc === rucIngresado);

                if (proveedor) {
                    document.getElementById("idproveedor").value = proveedor.idproveedor;
                    document.getElementById("proveedor").value = proveedor.nombre;
                    document.getElementById("codbarra").focus();
                } else {
                    alertify.error("RUC no encontrado en la lista de proveedores");
                    document.getElementById("idproveedor").value = "";
                    document.getElementById("proveedor").value = "";
                    document.getElementById("ruc").focus();
                }
            });
            // Evento para ver tablas de compras y detalles
            document.getElementById("linkVerTablas").addEventListener("click", function(e) {
                e.preventDefault();
                consultaCompras();
                const modal = new bootstrap.Modal(document.getElementById('modalVerTablas'));
                modal.show();
            });

            
            
            // Evento para buscar artículo por código de barra
            document.getElementById('btnBuscarArticulo').addEventListener('click', buscarArticuloPorCodBarra);
            document.getElementById('codbarra').addEventListener('blur', function() {
                const codbarra = this.value?.trim();

                if (codbarra === undefined || codbarra === "") 
                    return; // no hace nada si está vacío
            
                var producto = articulosConNombres.find(p => p.codbarra === codbarra);

                if (producto) {
                    document.getElementById("idarticulo").value = producto.idarticulo;
                    document.getElementById("descripcion").value = producto.descripcion + "-" + producto.marca + "/" + producto.clasificacion;
                    document.getElementById("preuni").value = producto.preventa;
                    
                    // selecciona el <select> y le asigna el IVA del producto
                    const selIva = document.getElementById("tipoIva");
                    // suponemos que producto.iva viene con valores: "EXENTA", "IVA5" o "IVA10"
                    if (producto.tiva && selIva.querySelector(`option[value="${producto.tiva}"]`)) {
                        selIva.value = producto.tiva;
                    } else {
                        // valor por defecto si no coincide
                        selIva.value = "0";
                    }
                    document.getElementById("cantidad").focus();
                } else {
                    alertify.error("CÓDIGO DE BARRA no encontrado en la lista de productos");
                    document.getElementById("idarticulo").value = "";
                    document.getElementById("descripcion").value = "";
                    document.getElementById("preuni").value = "";
                    const selIva = document.getElementById("tipoIva");
                    selIva.value = "0";
                    document.getElementById("codbarra").focus();
                }
            });

            document.getElementById('codbarra').addEventListener('input', function() {
            const codbarra = this.value?.trim();
            if (!codbarra) {
                document.getElementById("idarticulo").value = "";
                document.getElementById("descripcion").value = "";
                document.getElementById("preuni").value = "";
                calcularSubtotal();
                return;
            }
            var producto = articulosConNombres.find(p => p.codbarra === codbarra);
            if (producto) {
                document.getElementById("idarticulo").value = producto.idarticulo;
                document.getElementById("descripcion").value = producto.descripcion + "-" + producto.marca + "/" + producto.clasificacion;
                document.getElementById("preuni").value = producto.preventa;
            } else {
                document.getElementById("idarticulo").value = "";
                document.getElementById("descripcion").value = "";
                document.getElementById("preuni").value = "";
            }
            calcularSubtotal();
        });
            
            // Evento para agregar artículo a la tabla
            document.getElementById('btnAgregarArticulo').addEventListener('click', agregarArticuloATabla);
            
            // Evento para eliminar artículo de la tabla
            document.getElementById('tablaArticulos').addEventListener('click', function(e) {
                if (e.target.closest('.btn-eliminar-articulo')) {
                    const idArticulo = e.target.closest('.btn-eliminar-articulo').dataset.id;
                    eliminarArticuloDeTabla(parseInt(idArticulo));
                }
            });
            


            // Evento para guardar la compra
            //document.getElementById('formCompras').addEventListener('submit', guardarCompra);
            
            // Evento para cancelar compra
            // document.getElementById('formCompras').addEventListener('reset', limpiarFormulario);
            
            // Evento para teclas F2 y F3
            document.addEventListener('keydown', function(e) {
                // F2 para buscar proveedor
                if (e.key === 'F2') {
                    e.preventDefault();
                    buscarProveedorPorRUC();
                }
                
                // F4 para buscar artículo
                if (e.key === 'F4') {
                    e.preventDefault();
                    buscarArticuloPorCodBarra();
                }
            });

            const inputFactura = document.getElementById('numfactura');
            // Validar NumFactura
            inputFactura.addEventListener('input', () => {
                // Solo números
                let v = inputFactura.value.replace(/\D/g, '');
                // Insertar guiones automáticamente
                if (v.length > 3 && v.length <= 6) {
                    v = v.slice(0,3) + '-' + v.slice(3);
                } else if (v.length > 6) {
                    v = v.slice(0,3) + '-' + v.slice(3,6) + '-' + v.slice(6,13);
                }
                inputFactura.value = v;
            });
            // Validar al salir del campo
            // inputFactura.addEventListener('blur', () => {
            //     const patron = /^\d{3}-\d{3}-\d{7}$/;
            //     if (!patron.test(inputFactura.value.trim())) {
            //         inputFactura.setCustomValidity('Número de Factura inválido: ej. 100-100-1234567');
            //     } else {
            //         inputFactura.setCustomValidity('');
            //     }
            //     inputFactura.reportValidity();
            // });
            
            // Evento para validar campos numéricos
            // const camposNumericos = ['numfactura', 'codbarra'];
            // camposNumericos.forEach(campo => {
            //     document.getElementById(campo).addEventListener('input', function() {
            //         validarCampoNumerico(this);
            //     });
            // });
        }


        /**
         * Valida que un campo solo contenga números
         * @param {HTMLElement} elemento = Campo a validar
         */
        // function validarCampoNumerico(elemento) {
            
        //     // Caso especial para RUC (permite un guión)
        //     if (elemento.id === 'ruc') {
        //         let v = elemento.value;      
                
        //         // 1) eliminar todo lo que no sea dígito o guion
        //         v = v.replace(/[^0-9-]/g, '');

        //         // 2) permitir un solo guion
        //         const partes = v.split('-');
        //         if (partes.length > 2) {
        //             // juntamos todo tras el primer guion
        //             v = partes[0] + '-' + partes.slice(1).join('');
        //         }

        //         // 3) tras el guion, máximo un dígito
        //         const [antes, despues] = v.split('-');
        //         if (typeof despues !== 'undefined' && despues.length > 1) {
        //             v = antes + '-' + despues.charAt(0);
        //         }

        //         console.log(v)

        //         elemento.value = v;
        //     } else {
        //         // Para los demás campos, solo permitir números
        //         elemento.value = elemento.value.replace(/[^0-9]/g, '');
        //     }
            
        //     // Validar longitud máxima si está definida
        //     if (elemento.maxLength && elemento.value.length > elemento.maxLength) {
        //         elemento.value = elemento.value.slice(0, elemento.maxLength);
        //     }
        // }


        /**
         * Función para mostrar todos los proveedores disponibles
         */
        function buscarProveedorPorRUC() {
            // Si ya existe una instancia de DataTable, destruirla
            if ($.fn.DataTable.isDataTable("#tabla_proveedores")) {
                $('#tabla_proveedores').DataTable().clear().destroy();
            }

            // Inicializar el DataTable
            tabla = new DataTable("#tabla_proveedores", {
                data: proveedores,
                language: spanish,
                searching: true,    
                lengthChange: false, 
                pageLength: 5,
                columns: [
                    { data: 'idproveedor', title: 'Id Proveedor', visible: false },
                    { data: 'ruc', title: 'RUC' },
                    { data: 'nombre', title: 'Razón Social' },
                    { data: 'direccion', title: 'Dirección' },
                    { data: 'celular', title: 'Teléfono' },
                    { data: 'ciudad', title: 'Ciudad' }
                ],

            });

            const modalProveedor = new bootstrap.Modal('#modalProveedores');
            modalProveedor.show();

            $("#tabla_proveedores tbody").on("click", "tr", function() {
                const datos = tabla.row(this).data();
                $("#ruc").val(datos.ruc);
                $("#modalProveedores").modal("hide");
                document.getElementById("ruc").focus();
                document.getElementById("codbarra").focus();
            });


            
        }

         /**
         * Función para mostrar todos los productos disponibles
         */
         function buscarArticuloPorCodBarra() {

            // Si ya existe una instancia de DataTable, destruirla
            if ($.fn.DataTable.isDataTable("#tabla_articulos")) {
                $('#tabla_articulos').DataTable().clear().destroy();
            }

            // Inicializar el DataTable
            tabla = new DataTable("#tabla_articulos", {
                data: articulosConNombres,
                language: spanish,
                searching: true,    
                lengthChange: false, 
                pageLength: 5,
                columns: [
                    { data: 'idarticulo', title: 'Id Artículo', visible: false },
                    { data: 'codbarra', title: 'Código de Barras' },
                    { data: 'descripcion', title: 'Descripción' },
                    { data: 'marca', title: 'Marca' },
                    { data: 'clasificacion', title: 'Clasificación' },
                    {
                        data: 'tiva',
                        title: 'I.V.A.',
                        render: function(data, type, row) {
                            if (data === 0) return "EXENTA";
                            if (data === 5) return "5%";
                            if (data === 10) return "10%";
                            return data; // en caso de valor inesperado
                        }
                    },
                    {
                        data: 'stockactual',
                        title: 'Stock Actual',
                        render: function(data, type, row) {
                        let num = parseFloat(data).toFixed(2); // 2 decimales
                        return num.replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                        }
                    },
                    {
                        data: 'precio',//campo de precio de venta
                        title: 'Precio Venta',
                        render: function(data, type, row) {
                        return parseInt(data).toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                        }
                    }
                ],

            });

            const modalArticulo = new bootstrap.Modal('#modalArticulos');
            modalArticulo.show();

            $("#tabla_articulos tbody").on("click", "tr", function() {
                const datos = tabla.row(this).data();
                $("#codbarra").val(datos.codbarra);
                modalArticulo.hide();
                document.getElementById("codbarra").focus();
                document.getElementById("cantidad").focus();
                calcularSubtotal();
            });


            

            // Escuchar cambios en cantidad y precio unitario
            document.getElementById("cantidad").addEventListener("input", calcularSubtotal);
            document.getElementById("preuni").addEventListener("input", calcularSubtotal);
        }

        /**
         * Agrega un artículo a la tabla de detalle
         */
        let articulosCompra = [];//array para guardar temporalmente los artículos de la compra

        function agregarArticuloATabla() {
            // Validar campos obligatorios
            const idArticulo = document.getElementById('idarticulo').value;
            const codBarra = document.getElementById('codbarra').value;
            const descripcion = document.getElementById('descripcion').value;
            const cantidad = parseInt(document.getElementById('cantidad').value);
            const precioUnitario = Number(document.getElementById('preuni').value.split('.').join('').replace(/\./g, ""));
            const subtotal = Number(document.getElementById('subtotal').value.split('.').join('').replace(/\./g, ""));
            const tipoIva = document.getElementById('tipoIva').value;
            
            // Validar entradas
            if (!idArticulo || !codBarra || !descripcion || isNaN(cantidad) || cantidad <= 0 || isNaN(precioUnitario) || precioUnitario <= 0) {
                alertify.error('Comp e correctamente todos los campos del artículo');
                return;
            }
            
            // Verificar si el artículo ya existe en la tabla
            const articuloExistente = articulosCompra.findIndex(a => a.idarticulo == idArticulo);
            
            // Calcular importes según tipo de IVA
            
            const importeTotal = cantidad * precioUnitario;
            let exenta = 0;
            let iva5 = 0;
            let iva10 = 0;
            
            
            switch (tipoIva) {
                case '0':
                    exenta = importeTotal*0;
                    break;
                case '5':
                    iva5 = importeTotal*0.05;
                    break;
                case '10':
                    iva10 = importeTotal*0.10;
                    break;
            }
            
            // Si el artículo ya existe, actualizar cantidad e importes
            if (articuloExistente >= 0) {
                articulosCompra[articuloExistente].cantidad += cantidad;
                articulosCompra[articuloExistente].exenta += exenta;
                articulosCompra[articuloExistente].iva5 += iva5;
                articulosCompra[articuloExistente].iva10 += iva10;
                articulosCompra[articuloExistente].subtotal += subtotal;
            } else {
                // Crear nuevo registro en el detalle
                const nuevoArticulo = {
                    idarticulo: parseInt(idArticulo),
                    codbarra: codBarra,
                    descripcion: descripcion,
                    cantidad: cantidad,
                    preuni: precioUnitario,
                    subtotal: subtotal,
                    exenta: exenta,
                    iva5: iva5,
                    iva10: iva10,
                    tipoiva: tipoIva
                };
                
                articulosCompra.push(nuevoArticulo);
                tablaDetalle.push(nuevoArticulo);
            }
            
            // Actualizar tabla y totales
            actualizarTabla();
            calcularTotales();
            limpiarCamposArticulo();
        }

        /**
         * Actualiza la tabla de detalle
         */
        function actualizarTabla() {
            tablaDetalle.clear().rows.add(articulosCompra).draw();
        }

        /**
         * Calcula los totales de la compra
         */
        function calcularTotales() {
            totalExenta = 0;
            total5 = 0;
            total10 = 0;
            SUBTOTAL = 0;
           // const subtotal = Number(document.getElementById('subtotal').value.split('.').join('').replace(/\./g, ""));
            
            // Sumar totales por tipo de IVA
            articulosCompra.forEach(item => {
                totalExenta += item.exenta;
                total5 += item.iva5;
                total10 += item.iva10;
            });

            articulosCompra.forEach(item => {
                SUBTOTAL += item.subtotal;
            });
            
            // Calcular liquidaciones de IVA
            liq5 = total5 / 21; // IVA 5% = total / 21
            liq10 = total10 / 11; // IVA 10% = total / 11
            
            // Calcular total general
            totalGeneral = totalExenta + total5 + total10;
            totalAPagar = SUBTOTAL + totalGeneral;
            
            // Mostrar totales con formato de moneda
            document.getElementById('totExenta').value = formatearDecimal(totalExenta);
            document.getElementById('tot5').value = formatearDecimal(total5);
            document.getElementById('tot10').value = formatearDecimal(total10);
            document.getElementById('liq5').value = formatearDecimal(liq5);
            document.getElementById('liq10').value = formatearDecimal(liq10);
            document.getElementById('total').value = formatearDecimal(totalGeneral);
            document.getElementById('totalApagar').value = formatearDecimal(totalAPagar);
        }

        /**
         * Formatea un número como moneda
         * @param {number} valor - Valor a formatear
         * @returns {string} - Valor formateado
         */
        function formatearDecimal(valor) {
            return new Intl.NumberFormat('es-PY', { 
                style: 'currency', 
                currency: 'PYG',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(valor);
        }

        /**
         * Limpia los campos del formulario de artículos
         */
        function limpiarCamposArticulo() {
            document.getElementById('idarticulo').value = '';
            document.getElementById('codbarra').value = '';
            document.getElementById('descripcion').value = '';
            document.getElementById('cantidad').value = '1';
            document.getElementById('preuni').value = '';
            document.getElementById('tipoIva').value = '0';
            document.getElementById('codbarra').focus();
        }

        /**
         * Elimina un artículo de la tabla de detalle
         * @param {number} idArticulo - ID del artículo a eliminar
         */
        function eliminarArticuloDeTabla(idArticulo) {
            articulosCompra = articulosCompra.filter(a => a.idarticulo !== idArticulo);
            detalleCompra = detalleCompra.filter(a => a.idarticulo !== idArticulo);
            actualizarTabla();
            calcularTotales();
        }

        // document.getElementById("btnVerTablas").addEventListener("click", function(e) {
        //     e.preventDefault();
        //     consultaCompras();
        //     // Abre el modal manualmente
        //     const modal = new bootstrap.Modal(document.getElementById('modalVerTablas'));
        //     modal.show();
        // });

        // document.getElementById("linkInformeCompras").addEventListener("click", function(e) {
        //     e.preventDefault();
        //     aplicarFiltrosInformeCompras();
        //     // Abre el modal manualmente
        //     const modal = new bootstrap.Modal(document.getElementById('modalInformeCompras'));
        //     modal.show();
        // });


        document.addEventListener("DOMContentLoaded", function () {
            const btnVerTablas = document.getElementById("btnVerTablas");
            const linkInformeCompras = document.getElementById("linkInformeCompras");

            if (btnVerTablas) {
                btnVerTablas.addEventListener("click", function (e) {
                    e.preventDefault();
                    consultaCompras();
                    const modal = new bootstrap.Modal(document.getElementById('modalVerTablas'));
                    modal.show();
                });
            }

            if (linkInformeCompras) {
                linkInformeCompras.addEventListener("click", function (e) {
                    e.preventDefault();
                    aplicarFiltrosInformeCompras();
                    const modal = new bootstrap.Modal(document.getElementById('modalInformeCompras'));
                    modal.show();
                });
            }
        });

        function formatearFechaDMY(fecha) {
            const d = new Date(fecha);
            const dia = String(d.getDate()).padStart(2, '0');
            const mes = String(d.getMonth() + 1).padStart(2, '0');
            const anio = d.getFullYear();
            return `${dia}/${mes}/${anio}`;
        }


        /**
         * Guarda la compra en localStorage
         * @param {Event} e - Evento del formulario
         */
        function guardarCompra() {
            // e.preventDefault();
        // Obtener valores primero
        const idproveedor = document.getElementById('idproveedor').value;
        const fechaInput = document.getElementById('fecha').value;
        const numFactura = document.getElementById('numfactura').value.trim();

        // Validar que haya un proveedor seleccionado
        if (!idproveedor) {
        alertify.error('Debe seleccionar un proveedor');
        return;
        }

        // Validar fecha
        const hoy = new Date().toISOString().split('T')[0];
        if (!fechaInput || fechaInput === "0001-01-01" || fechaInput < "2015-12-01") {
        alertify.error('Debe ingresar una fecha válida');
        return;
        }
        if (fechaInput > hoy) {
        alertify.error('La fecha no puede ser mayor a hoy');
        return;
        }

        // Validar que haya artículos en el detalle
        if (articulosCompra.length == 0) {
        alertify.error('Debe agregar al menos un artículo a la compra');
        return;
        }

        // Validar número de factura
        if (!numFactura) {
        alertify.error('Ingrese el número de factura');
        return;
        }

        // Validar formato de factura
        const patron = /^\d{3}-\d{3}-\d{7}$/;
        if (!patron.test(numFactura)) {
        alertify.error('Número de Factura inválido: ej. 100-100-1234567');
        return;
        }

        

        // Obtener compras guardadas
        let comprasActualizadas = JSON.parse(localStorage.getItem("compras")) || [];

        // Normalizar función para comparar facturas
        const normalizarFactura = f => (f || '').replace(/\s+/g, '').toUpperCase();

        // Validar si ya existe una factura con el mismo número, proveedor y fecha
        const facturaExistente = comprasActualizadas.some(c =>
        normalizarFactura(c.numfactura) === normalizarFactura(numFactura) &&
        String(c.idproveedor) === String(idproveedor) &&
        c.fecha === fechaInput
        );
        if (facturaExistente) {
        alertify.error('Ya existe una factura con ese número, proveedor y fecha');
        return;
        }

            // Justo antes de la validación de factura existente:
            // let comprasActualizadas = JSON.parse(localStorage.getItem("compras")) || [];
            // const facturaExist = comprasActualizadas.some(c =>
            //     (c.numfactura || '').trim() === numFactura &&
            //     String(c.idproveedor) === String(idProveedor)
            // );
            // if (facturaExist) {
            //     alertify.error('Ya existe una factura con ese número para este proveedor');
            //     return;
            // }
            // // Verificar si la factura ya existe
            // const normalizarFactura = f => (f || '').replace(/\s+/g, '').toUpperCase();
            // const facturaExistente = compras.some(c => c.numfactura === numFactura && String(c.idproveedor) === String(idProveedor));
            // if (facturaExistente) {
            //     alertify.error('Ya existe una factura con ese número para este proveedor');
            //     return;
            // }
            
            // Normalizar RUC para guardar
            const rucNormalizado = document.getElementById('ruc').value.trim();
            
            // Crear objeto de compra
            const nuevaCompra = {
                idcompra: obtenerSiguienteId(compras),
                numfactura: numFactura,
                fecha: document.getElementById('fecha').value,
                condicion: document.getElementById('condicion').value,
                idproveedor: parseInt(idproveedor),
                proveedor: document.getElementById('proveedor').value,
                ruc: document.getElementById('ruc').value, 
                totexenta: totalExenta,
                tot5: total5,
                tot10: total10,
                liq5: liq5,
                liq10: liq10,
                total: totalAPagar,
                totcompra: totalAPagar, 
                totiva: totalGeneral,
                // detalle: [...detalleCompra], // Clonar el array para evitar referencias
                anulado: 'NO',
                // pagado: 'NO'// le agrege :(
                 pagado: (document.getElementById('condicion').value === "CONTADO") ? "SI" : "NO"
            };
            
            // Guardar compra en localStorage
            
            // Actualizar stock de artículos (opcional)
            actualizarStockArticulos();


            // ¡Recarga los arrays en memoria!
            articulos = JSON.parse(localStorage.getItem("articulos")) || [];
            articulosConNombres = articulos.map(a => ({
                ...a,
                marca: dicMarcas[a.idmarca] || "Desconocido",
                clasificacion: dicClasificaciones[a.idclasificacion] || "Desconocido"
            }));
            
            // alert(articulosCompra.length)

            // Guardar detalles
            let comprasdetalle = JSON.parse(localStorage.getItem("comprasdetalle")) || [];
            let lastIdDetalle = comprasdetalle.length > 0 ? Math.max(...comprasdetalle.map(d => d.idcompradet || 0)) : 0;


            nuevaCompra.fecha = formatearFechaDMY(new Date());

            if (nuevaCompra.condicion === "CONTADO") {
                let ordenesPago = JSON.parse(localStorage.getItem("ordenesPago") || "[]");
                ordenesPago.push({
                    proveedor: nuevaCompra.proveedor,
                    ruc: nuevaCompra.ruc,
                    fecha: formatearFechaDMY(new Date()),
                    facturas: [nuevaCompra.idcompra],
                    total: nuevaCompra.totcompra,
                    metodo: "Contado",
                    banco: "",
                    pagado: "SI"
                });
                localStorage.setItem("ordenesPago", JSON.stringify(ordenesPago));
            }
            
            

            if (articulosCompra.length == 0) {
                alertify.error('No se han agregado artículos a la compra');
                return;
            } else{
                let compras = JSON.parse(localStorage.getItem("compras")) || [];  
                compras.push(nuevaCompra);
                localStorage.setItem('compras', JSON.stringify(compras));
                articulosCompra.forEach((art, idx) => {
                    comprasdetalle.push({
                        idcompradet: lastIdDetalle + idx + 1,
                        idcompra: nuevaCompra.idcompra,
                        ...art
                    });
                });
                localStorage.setItem("comprasdetalle", JSON.stringify(comprasdetalle)); // <-- Guarda después de agregar
                alertify.success('Compra registrada correctamente');
                limpiarFormulario();
                consultaCompras();
            }
        }

        /**
         * Actualiza el stock de los artículos
         */
        function actualizarStockArticulos() {
            // Esta función es opcional y dependería de cómo manejes el stock en tu aplicación
            // Ejemplo básico:

            const porcentajeGanancia = 30; // Puedes cambiar este valor según tu política
            articulosCompra.forEach(item => {
                const index = articulos.findIndex(a => a.idarticulo === item.idarticulo);
                if (index !== -1) {
                    // Si el artículo existe, aumentar su stock
                    articulos[index].stockactual = (articulos[index].stockactual || 0) + item.cantidad;
                    // Actualizar precio de costo
                    articulos[index].preciocosto = item.preuni;
                     // Calcular y actualizar precio de venta
                    articulos[index].preventa = item.preuni; // Guardar el costo de compra
                    articulos[index].precio = Math.round(item.preuni * (1 + porcentajeGanancia / 100)); 
                }
            });
            
            // Guardar artículos actualizados
            localStorage.setItem('articulos', JSON.stringify(articulos));
        }

        /**
         * Limpia completamente el formulario
         */
        function limpiarFormulario() {
            // Limpiar campos de proveedor
            document.getElementById('idproveedor').value = '';
            document.getElementById('ruc').value = '';
            document.getElementById('proveedor').value = '';
            
            // Limpiar campos de artículo
            limpiarCamposArticulo();
            
            // Limpiar tabla de detalle
            articulosCompra = [];
            actualizarTabla();
            
            // Restablecer totales
            totalExenta = 0;
            total5 = 0;
            total10 = 0;
            liq5 = 0;
            liq10 = 0;
            totalGeneral = 0;
            calcularTotales();
            
            // Establecer fecha actual
            const fechaActual = new Date().toISOString().split('T')[0];
            document.getElementById('fecha').value = fechaActual;
            
            // Restablecer número de factura y condición
            document.getElementById('numfactura').value = '';
            document.getElementById('condicion').value = 'CONTADO';
            
            // Establecer foco en número de factura
            document.getElementById('numfactura').focus();
        }

        /**
         * Obtiene el siguiente ID para una nueva compra
         * @param {Array} compras - Array de compras existentes
         * @returns {number} - Siguiente ID disponible
         */
        function obtenerSiguienteId(compras) {
            if (compras.length === 0) {
                return 1;
            } else {
                const maxId = Math.max(...compras.map(c => c.idcompra || 0));
                return maxId + 1;
            }
        }

        function formatear(num) {
            n = new Intl.NumberFormat("de-DE").format(num);
            return n;
        }

        function quitarSeparador(num) {
        // Convertir el número a cadena y verificar si contiene un punto
        if (num.toString().includes('.')) {
            // Si tiene un punto, quitar todos los puntos
            var n = num.toString().replace(/\./g, "");
            return n;
        } else {
            // Si no tiene un punto, devolver el número sin cambios
            return num.toString();
        }
        }


        function formatearDecimal(valor) {
            return new Intl.NumberFormat('es-ES', { 
                minimumFractionDigits: 2, 
                maximumFractionDigits: 2 
            }).format(valor);
        }

        

    //  ==================  CONSULTA DE COMPRAS  ========================  \\

        function consultaCompras() {
            compras = JSON.parse(localStorage.getItem("compras")) || []; // <-- ¡Actualiza aquí!
            let filas = ``;
            compras.forEach((c,index) => {
                // Busca el proveedor por idproveedor
                const prov = proveedores.find(p => p.idproveedor == c.idproveedor) || {};
                filas += `
                    <tr>
                        <td>${c.idcompra}</td>
                        <td>${ c.proveedor ?? prov.nombre ?? ""}</td>
                        <td>${c.ruc ?? prov.ruc ?? ""}</td>
                        <td>${c.FechaCompra ?? c.fecha ?? ""}</td>
                        <td>${c.condicion ?? ""}</td>
                        <td>${c.numfactura ?? ""}</td>
                        <td>${c.totiva ?? 0}</td>
                        <td>${c.totcompra ?? c.total ?? 0}</td>
                        <td>${c.pagado ?? 'NO'}</td> 
        
                        <td>
                            <button type="button" class="btn btn-warning detalle" data-id="${c.idcompra}">Detalle</button>
                            <button type="button" class="btn btn-danger anular" data-id="${c.idcompra}" ${c.anulado === "SI" ? "disabled" : ""}>Anular</button>
                        </td>
                    </tr>
                `;
                //         filas += `
                //         <tr>
                //             <td>${c.idcompra}</td>
                //             <td>${c.proveedor}</td>
                //             <td>${c.ruc}</td>
                //             <td>${c.fecha}</td>
                //             <td>${c.condicion}</td>
                //             <td>${c.numfactura}</td>
                //             <td>${formatearMoneda(c.total ?? c.totcompra ?? 0)}</td>
                //             <td>
                //                 <button type="button" class="btn btn-warning detalle" data-id="${c.idcompra}"><i class="bi bi-list"></i></button>
                //                 <button type="button" class="btn btn-danger anular" data-id="${c.idcompra}" ${c.anulado === "SI" ? "disabled" : ""}>Anular</button>
                //             </td>
                //         </tr>
                // `;
                // filas += 
                // `
                //     <td>${c.idcompra}</td>
                //     <td>${c.proveedor}</td>
                //     <td>${c.ruc}</td>
                //     <td>${c.fecha}</td>
                //     <td>${c.condicion}</td>
                //     <td>${c.numfactura}</td>
                //     <td>${c.numfactura}</td>
                    
                //     <td><button type="button" id= "${index}" class="btn btn-warning detalle"><i class="bi bi-list"></i> </button></td>
                // `;
            });
            document.getElementById("cabecera_compras").innerHTML = filas;
            // Limpia el detalle al abrir el modal
            document.getElementById("detalle_compras").innerHTML = "";

            document.getElementById("cabecera_compras").addEventListener("click", function(e) {
            if (e.target.closest(".anular")) {
                const id = e.target.closest(".anular").dataset.id;
                alertify.confirm(
                    "Anular compra",
                    "¿Está seguro que desea anular esta compra?",
                    function() {
                        anularCompra(id);
                    },
                    function() {
                        alertify.error("Anulación cancelada");
                    }
                ).set('labels', { ok: 'Sí', cancel: 'No' });
            }
            // ...otros eventos...
            });

        }

        // Evento delegado para ver detalle de la compra
        document.getElementById("cabecera_compras").addEventListener("click", function(e) {
            if (e.target.closest(".detalle")) {
                const id = parseInt(e.target.closest(".detalle").dataset.id);
                mostrarDetalleCompra(id);
            }
            // if (e.target.closest(".anular")) {
            //     const id = parseInt(e.target.closest(".anular").dataset.id);
            //     anularCompra(id);
            // }
        });

        // Mostrar el detalle de la compra seleccionada
        function mostrarDetalleCompra(idcompra) {
            const comprasdetalle = JSON.parse(localStorage.getItem("comprasdetalle")) || [];
            const articulos = JSON.parse(localStorage.getItem("articulos")) || [];
            const detalle = comprasdetalle.filter(d => d.idcompra == idcompra);
            let filas = "";
            detalle.forEach(d => {
                const art = articulos.find(a => a.idarticulo == d.idarticulo) || {};
                filas += `
                    <tr>
                        <td>${d.idarticulo}</td>
                        <td>${art.codbarra ?? ""}</td>
                        <td>${art.descripcion ?? ""}</td>
                        <td>${d.cantidad}</td>
                        <td>${formatearDecimal(d.preuni)}</td>
                        <td>${formatearDecimal(d.subtotal)}</td>
                        <td>${formatearDecimal(d.exenta ?? 0)}</td>
                        <td>${formatearDecimal(d.iva5 ?? 0)}</td>
                        <td>${formatearDecimal(d.iva10 ?? 0)}</td>
                    </tr>
                `;
            });
            document.getElementById("detalle_compras").innerHTML = filas;
        }

        // Formatear Decimal

        function formatearDecimal(valor) {
            return new Intl.NumberFormat('es-PY', { 
                style: 'currency', 
                currency: 'PYG',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(valor);
        }

        

        function anularCompra(idcompra) {
        let compras = JSON.parse(localStorage.getItem("compras")) || [];
        const idx = compras.findIndex(c => c.idcompra == idcompra);
        if (idx !== -1) {
            compras[idx].anulado = 'SI';
            localStorage.setItem("compras", JSON.stringify(compras));
            alertify.success("Compra anulada correctamente");
            consultaCompras(); // Vuelve a cargar la tabla para reflejar el cambio
        } else {
            alertify.error("No se encontró la compra");
        }
        }

        
        /**
         * Función para cerrar sesión
         */
        function cerrarSesion() {
            sessionStorage.removeItem("sesionActiva");
            localStorage.removeItem("nomUsuario");
            localStorage.removeItem("rolUsuario");
            window.location.href = "index.html";
        }




        // ================= FUNCIONES PARA EL MODAL DE INFORME DE COMPRAS =================

        // Filtrar y mostrar las compras en el informe
        function aplicarFiltrosInformeCompras() {
            const desde = document.getElementById("filtroDesdeCompras").value;
            const hasta = document.getElementById("filtroHastaCompras").value;
            const condicion = document.getElementById("filtroCondicionCompras").value;
            const estado = document.getElementById("filtroEstadoCompras").value;

            let compras = JSON.parse(localStorage.getItem("compras")) || [];
            let proveedores = JSON.parse(localStorage.getItem("proveedores")) || [];

            // // Filtrado
            // let filtradas = compras.filter(c => {
            //     let cumple = true;
            //     if (c.anulado === "SI") cumple = false; // Oculta compras anuladas
            //     // if (desde && c.fecha < desde) cumple = false;
            //     // if (hasta && c.fecha > hasta) cumple = false;
            //     if (desde && new Date(c.fecha) < new Date(desde)) cumple = false;
            //     if (hasta && new Date(c.fecha) > new Date(hasta)) cumple = false;
            //     if (condicion && c.condicion !== condicion) cumple = false;
            //     if (estado) {

            //         if (estado === "no" && c.pagado !== "SI") cumple = false; // Mostrar solo pagados
            //         if (estado === "si" && c.pagado !== "NO") cumple = false; // Mostrar solo NO pagados
            //         // if (estado === "pagada" && c.pagado !== "SI") cumple = false;
            //         // if (estado === "pendiente" && c.pagado !== "NO") cumple = false;
            //         // if (estado === "anulada" && c.anulado !== "SI") cumple = false;
            //     }
            //     return cumple;
            // });
            // Filtrado
    let filtradas = compras.filter(c => {
        // Oculta compras anuladas
        if (c.anulado === "SI") return false;

        // Filtro por fecha desde
     if (desde) {
    if ((c.fecha ?? "").substring(0, 10) < desde) return false;
}
// Filtro por fecha hasta
if (hasta) {
    if ((c.fecha ?? "").substring(0, 10) > hasta) return false;
}
        // Filtro por condición
        if (condicion && c.condicion !== condicion) return false;

        // Filtro por pagado
        if (estado) {
            if (estado === "no" && c.pagado !== "SI") return false; // Mostrar solo pagados
            if (estado === "si" && c.pagado !== "NO") return false; // Mostrar solo NO pagados
        }
        return true;
    });

            // Mostrar en la tabla
            let filas = "";
            filtradas.forEach(c => {
                const prov = proveedores.find(p => p.idproveedor == c.idproveedor) || {};
                filas += `
                    <tr>
                        <td>${c.numfactura ?? ""}</td>
                        <td>${c.fecha ?? c.FechaCompra ?? ""}</td>
                        <td>${c.proveedor ?? prov.nombre ?? ""}</td>
                        <td class="text-end">${formatearDecimal(c.totcompra ?? c.total ?? 0)}</td>
                        <td class="text-end">${formatearDecimal(c.totiva ?? 0)}</td>
                        <td>${c.condicion ?? ""}</td>
                        
                        <td>${c.pagado === "SI" ? "Sí" : "No"}</td>
                    </tr>
                `;
            });
            document.getElementById("cuerpoInformeCompras").innerHTML = filas;
        }

        // Restablecer filtros y mostrar todas las compras
        function resetearFiltrosInformeCompras() {
            document.getElementById("filtroDesdeCompras").value = "";
            document.getElementById("filtroHastaCompras").value = "";
            document.getElementById("filtroCondicionCompras").value = "";
            document.getElementById("filtroEstadoCompras").value = "";
            aplicarFiltrosInformeCompras();
        }

        // Exportar a Excel (usando SheetJS)
        function exportarExcelCompras() {
            let tabla = document.getElementById('tablaInformeCompras');
            let wb = XLSX.utils.table_to_book(tabla, {sheet: "InformeCompras"});
            XLSX.writeFile(wb, "InformeCompras.xlsx");
        }
        
        // Exportar a PDF (usando jsPDF y autoTable)
        function exportarPDFCompras() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const logoBase64 = 'data:image/jpeg;base64,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EDzg4mizkjOeo4J6np1Br0O51bw54Y0yTQJITJC8UbYBJ+0BzhmyOhA57dOKKt9Fuwj1OI1SwsU8awwW92/2S8COZYSRtLgZYD0B5288cVFqkMmiatDMl/PqKQtuRpo5Y+R9ew68Gn31mmha/dPot0zJYNsN1cAHy2PG1R3I5GQOxIAAzWv4bjuPF8rW0viy/jnxuMDKRvHfHzYOPoPpWjdkm3pb+ugt3Y2ptc1TxrpMEnh/UEsru3OZrfJRpHwSNrdxwflOO+exrEn+I/iLS47nTdUtYvtiqV8x02sjf3sdCO44x05Iqn4q8Maj4T1ZbnTmumtGT5bhSSykjDAkdCefwP1rb8PWmp+MvEFnqOsWii0s42UyvDt8/OcDHcc/TA9TzlaEVzaNfiVdt26nGWPiDUnNzBJfXUi3UTRupJfdkcYB7k9/r2rb+HniODwtq15a6tvt458KzMhOx1zwR1HUjvz6Cu9vPhroF1J5scEtq+c5t5Cv884/CpH+HuhzQKl1DLcyL1nllJkb6kdaUsRTlFq24KDTucT43ksv+Emtda0W9tb64lZA1sP3mWAwOB2IwMcH+jtM/wCErbw+NAsdFltkm3Ca5mQrncecZ4HHHf8AOvQtL8H6Jo0wmsbCNJR0kYlyPpnp+FblYuukkkr27lKDvdnM+GvBtloWn2iTRpNeQkyGU9nYAHHtwB+GetdNRRWDk5O7LSSCiiikMKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigArzn4j6FfzapaaxaWv2yKFPKlg2lsjJPT0IOMjp9a9GoqoTcHdCaurHidrYvr1mujaHoc9pHJcLJcXM8hcLgEAE7eAMk9z+NN8Z6Pdp4ygslRF+0LFFbAtnCLhFye2Sufxr22uP8AFHh+41Hxl4fvreMtHBITM2OFCkMM/XkV0U6/vXM3DQ4i6sbjw59ut/EGky3NnqOyUywEZikGeh5GQWI7ce3FXPA2kXF/4pt9SsrGSy0u0UqrSHl+COv8RJJJxwPYYFetUtS8Q2npqx8lmLRRRXOaBRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAf/9k'; // tu cadena base64    ; // tu logo aquí

            const fechaActual = new Date();
const fechaTexto = fechaActual.toLocaleDateString();
const horaTexto = fechaActual.toLocaleTimeString();

const titulo = "Informe Compras";

// Datos de la empresa
const empresa = "CASA YASY S.A";
const rucTel = "RUC: 80020495-6 | Tel: 0331 - 240003";
const direccion = "Dir: MAYOR LORENZO MEDINA 228";

const anchoImagen = 40;
const altoImagen = 20;
const centroX = (doc.internal.pageSize.getWidth() - anchoImagen) / 2;

let y = 20; // Espacio superior inicial

// Logo centrado
doc.addImage(logoBase64, 'PNG', centroX, y, anchoImagen, altoImagen);
y += altoImagen + 10; // Espacio después del logo

// Empresa
doc.setFontSize(16);
doc.setFont("helvetica", "bold");
doc.text(empresa, doc.internal.pageSize.getWidth() / 2, y, { align: 'center' });
y += 7;

doc.setFontSize(10);
doc.setFont("helvetica", "normal");
doc.text(rucTel, doc.internal.pageSize.getWidth() / 2, y, { align: 'center' });
y += 5;
doc.text(direccion, doc.internal.pageSize.getWidth() / 2, y, { align: 'center' });
y += 10;

// Título
doc.setFontSize(13);
doc.setFont("helvetica", "bold");
doc.text(titulo, doc.internal.pageSize.getWidth() / 2, y, { align: 'center' });
y += 6;


// Tabla
const tabla = document.getElementById("tablaInformeCompras");
const headers = [];
const rows = [];

tabla.querySelectorAll("thead tr th").forEach(th => headers.push(th.textContent.trim()));
tabla.querySelectorAll("tbody tr").forEach(tr => {
    const row = [];
    tr.querySelectorAll("td").forEach(td => row.push(td.textContent.trim()));
    rows.push(row);
});

doc.autoTable({
    head: [headers],
    body: rows,
    startY: y + 5,
    margin: { left: 14, right: 14 },
    styles: { fontSize: 8 },
    headStyles: { fillColor: [52, 58, 64], textColor: 255 },
    alternateRowStyles: { fillColor: [245, 245, 245] },
    didDrawPage: function (data) {
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const pageCount = doc.internal.getNumberOfPages();
    const pageNumber = doc.internal.getCurrentPageInfo().pageNumber;

    doc.setFontSize(8);
    // Pie de página: número de página (izquierda)
    doc.text(`Página ${pageNumber} de ${pageCount}`, data.settings.margin.left, pageHeight - 5);

    // Pie de página: fecha y hora (derecha)
    const fechaHoraTexto = `${fechaTexto} ${horaTexto}`;
    const textWidth = doc.getTextWidth(fechaHoraTexto);
    doc.text(fechaHoraTexto, pageWidth - 14 - textWidth, pageHeight - 5);
}
    
});

doc.save("Infrome Compras.pdf");
        }


        // Al abrir el modal, mostrar todos los datos por defecto
        document.getElementById("modalInformeCompras").addEventListener("show.bs.modal", aplicarFiltrosInformeCompras);
                


    //**********************************************************
    // se guarda en una variable el rol de usuario que se encuentra en el localstorage
    // var cargo = localStorage.getItem("rolUsuario");

    // //Si el cargo es Admin, entonces remueve la clase d-none de bootstrap y muestra todo
    // if(cargo==="Administrador"){
    //   document.getElementById("Usuarios").classList.remove('d-none');
    //   document.getElementById("Proveedores").classList.remove('d-none');
    //   document.getElementById("Compras").classList.remove('d-none');
    //   document.getElementById("Bancos").classList.remove('d-none');
    //   document.getElementById("Pproveedores").classList.remove('d-none');
    //   document.getElementById("Ventas").classList.remove('d-none');
    //   document.getElementById("Clientes").classList.remove('d-none');
    //   document.getElementById("Marcas").classList.remove('d-none');
    //   document.getElementById("Familias").classList.remove('d-none');
    //   document.getElementById("Articulos").classList.remove('d-none');
    // }
    // if(cargo==="Codificador"){
    //   document.getElementById("Usuarios").classList.remove('d-none');
    //   document.getElementById("Proveedores").classList.remove('d-none');
    //   document.getElementById("Compras").classList.remove('d-none');
    //   document.getElementById("Pproveedores").classList.remove('d-none');
    //   document.getElementById("Marcas").classList.remove('d-none');
    //   document.getElementById("Familias").classList.remove('d-none');
    //   document.getElementById("Articulos").classList.remove('d-none');
    // }
    // if(cargo==="Cajero"){
    //   document.getElementById("Clientes").classList.remove('d-none');
    //   document.getElementById("Ventas").classList.remove('d-none');
    // }

    </script>
       <!-- jsPDF y autoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <!-- SheetJS (xlsx) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <div id="facturaImprimir" style="display: none; font-family: monospace; width: 80mm; padding: 10px;">
        <div id="contenidoFactura"></div>
    </div>
    
</body>